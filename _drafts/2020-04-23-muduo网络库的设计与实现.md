---
layout: post
title: muduo网络库的设计与实现
date:   2020-04-23 10:09:44 +0800
categories: C++
---


# muduo网络库的设计与实现


## 1. 什么都不做的EventLoop

```c
void abortNotInLoopThread();
void handleRead(); // wake up
void doPendingFunctors();
void printActiveChannels() const;
typedef std::vector<Channel*> ChannelList;

bool looping_;
std::atomic<bool> quit_;
bool eventHandling_;
bool callingPendingFunctors_;
int64_t iteration_;
const pid_t threadId_;
Timestamp pollReturnTime_;
std::unique_ptr<Poller> poller_;
std::unique_ptr<TimerQueue> timerQueue_;
int wakeupFd_;

std::unique_ptr<Channel> wakeupChannel_;
boost::any context_;

ChannelList activeChannels_;
Channel* currentActiveChannel_;

mutable MutexLock mutex_;
std::vector<Functor> pendingFunctors_;
```



- EventLoop继承boost::noncopyable是不可拷贝的。

- 每个线程只有一个EventLoop对象(one loop per thread)，EventLoop的构造函数会检查当前线程是否已经创建其他的EventLoop对象。

  ```c
  __thread EventLoop* t_loopInThisThread = 0;
  
  if (t_loopInThisThread) {
      LOG_FATAL << "Another EventLoop " << t_loopInThisThread << " exists in this thread " << threadId_;
  }else {
      t_loopInThisThread = this;
  }
  ```

  
